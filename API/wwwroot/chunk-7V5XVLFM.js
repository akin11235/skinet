import{a as _}from"./chunk-WB4Y2BXC.js";import{a as Q}from"./chunk-M3AJA76C.js";import{J as W,K as Ce,L as X,M as I,N as Se,O as Fe,P as Ee,d as ye,e as y,f as S,g as F,k as be,m as E,n as x,o as w,r as ge,t as k,u as ke}from"./chunk-N55XXCRU.js";import{$a as pe,Ba as A,Ea as b,Fa as h,G as ne,H as j,Hb as q,Ia as L,Ib as U,J as ae,Ja as se,Kb as J,La as O,Lb as he,Ma as V,N as f,Na as B,O as T,Oa as ce,Pa as p,Qa as R,Sa as me,T as G,U as D,_a as le,da as m,ea as u,f as M,lb as de,mb as g,p as ie,pa as v,q as oe,ra as c,sb as ue,tb as fe,va as n,wa as s,xa as l,xb as ve}from"./chunk-LFT74A4M.js";function Qe(i,e){if(i&1){let a=A();n(0,"div",6)(1,"div",7)(2,"h4"),p(3,"Shipping address"),s(),n(4,"button",8),b("click",function(){G(a);let t=h();return D(t.saveUserAddress())}),p(5," Save as default address "),s()(),n(6,"div",9)(7,"div",10),l(8,"app-text-input",11),s(),n(9,"div",10),l(10,"app-text-input",12),s(),n(11,"div",10),l(12,"app-text-input",13),s(),n(13,"div",10),l(14,"app-text-input",14),s(),n(15,"div",10),l(16,"app-text-input",15),s(),n(17,"div",10),l(18,"app-text-input",16),s()()()}if(i&2){let a,r=h();c("formGroup",r.checkoutForm),m(4),c("disabled",!((a=r.checkoutForm.get("addressForm"))!=null&&a.valid)||!((a=r.checkoutForm.get("addressForm"))!=null&&a.dirty)),m(4),c("label","First name"),m(2),c("label","Last name"),m(2),c("label","Street"),m(2),c("label","City"),m(2),c("label","State"),m(2),c("label","Zip code")}}var Ie=(()=>{let e=class e{constructor(r,t){this.accountService=r,this.toastr=t}saveUserAddress(){this.accountService.updateUserAddress(this.checkoutForm?.get("addressForm")?.value).subscribe({next:()=>{this.toastr.success("Address saved"),this.checkoutForm?.get("addressForm")?.reset(this.checkoutForm?.get("addressForm")?.value)}})}};e.\u0275fac=function(t){return new(t||e)(u(Q),u(_))},e.\u0275cmp=f({type:e,selectors:[["app-checkout-address"]],inputs:{checkoutForm:"checkoutForm"},decls:8,vars:2,consts:[["class","mt-4",3,"formGroup",4,"ngIf"],[1,"d-flex","justify-content-between","flex-row","mb-5"],["routerLink","/basket",1,"btn","btn-outline-primary"],[1,"fa","fa-angle-left"],["cdkStepperNext","",1,"btn","btn-primary",3,"disabled"],[1,"fa","fa-angle-right"],[1,"mt-4",3,"formGroup"],[1,"d-flex","justify-content-between","align-items-center"],[1,"btn","btn-outline-success","mb-3",3,"click","disabled"],["formGroupName","addressForm",1,"row"],[1,"form-group","col-6"],["formControlName","firstName",3,"label"],["formControlName","lastName",3,"label"],["formControlName","street",3,"label"],["formControlName","city",3,"label"],["formControlName","state",3,"label"],["formControlName","zipCode",3,"label"]],template:function(t,o){if(t&1&&(v(0,Qe,19,8,"div",0),n(1,"div",1)(2,"button",2),l(3,"i",3),p(4,"Back to basket "),s(),n(5,"button",4),p(6," Go to delivery"),l(7,"i",5),s()()),t&2){let d;c("ngIf",o.checkoutForm),m(5),c("disabled",o.checkoutForm==null||(d=o.checkoutForm.get("addressForm"))==null?null:d.invalid)}},dependencies:[g,U,S,F,E,w,x,W,X]});let i=e;return i})();var Y=(()=>{let e=class e{constructor(r){this.http=r,this.baseUrl=he.apiUrl}createOrder(r){return this.http.post(this.baseUrl+"orders",r)}getDeliveryMethods(){return this.http.get(this.baseUrl+"orders/deliveryMethods").pipe(oe(r=>r.sort((t,o)=>o.price-t.price)))}};e.\u0275fac=function(t){return new(t||e)(ae(ve))},e.\u0275prov=ne({token:e,factory:e.\u0275fac,providedIn:"root"});let i=e;return i})();function Xe(i,e){if(i&1){let a=A();n(0,"div",9)(1,"input",10),b("click",function(){let t=G(a).$implicit,o=h(2);return D(o.setShippingPrice(t))}),s(),n(2,"label",11)(3,"strong"),p(4),le(5,"currency"),s(),l(6,"br"),n(7,"span",12),p(8),s()()()}if(i&2){let a=e.$implicit;m(),L("value",a.id),L("id",a.id),m(),L("for",a.id),m(2),me(" ",a.shortName," - ",pe(5,6,a.price)," "),m(4),R(a.description)}}function He(i,e){if(i&1&&(n(0,"div",6)(1,"div",7),v(2,Xe,9,8,"div",8),s()()),i&2){let a=h();c("formGroup",a.checkoutForm),m(2),c("ngForOf",a.deliveryMethods)}}var Ne=(()=>{let e=class e{constructor(r,t){this.checkoutService=r,this.basketService=t,this.deliveryMethods=[]}ngOnInit(){this.checkoutService.getDeliveryMethods().subscribe({next:r=>this.deliveryMethods=r})}setShippingPrice(r){this.basketService.setShippingPrice(r)}};e.\u0275fac=function(t){return new(t||e)(u(Y),u(k))},e.\u0275cmp=f({type:e,selectors:[["app-checkout-delivery"]],inputs:{checkoutForm:"checkoutForm"},decls:8,vars:2,consts:[["class","mt-4",3,"formGroup",4,"ngIf"],[1,"d-flex","justify-content-between","flex-row","mb-5"],["cdkStepperPrevious","",1,"btn","btn-outline-primary"],[1,"fa","fa-angle-left"],["cdkStepperNext","",1,"btn","btn-primary",3,"disabled"],[1,"fa","fa-angle-right"],[1,"mt-4",3,"formGroup"],["formGroupName","deliveryForm",1,"row"],["class","col-6 form-group",4,"ngFor","ngForOf"],[1,"col-6","form-group"],["type","radio","formControlName","deliveryMethod",1,"form-check-input",3,"click","value","id"],[1,"form-check-label","ms-2","mb-3",3,"for"],[1,"label-description"]],template:function(t,o){if(t&1&&(v(0,He,3,2,"div",0),n(1,"div",1)(2,"button",2),l(3,"i",3),p(4,"Back to address "),s(),n(5,"button",4),p(6," Go to review"),l(7,"i",5),s()()),t&2){let d;c("ngIf",o.checkoutForm),m(5),c("disabled",o.checkoutForm==null||(d=o.checkoutForm.get("deliveryForm"))==null?null:d.invalid)}},dependencies:[de,g,ye,be,S,F,E,w,x,X,I,ue]});let i=e;return i})();var Pe=(()=>{let e=class e{constructor(r,t){this.basketService=r,this.toastr=t}createPaymentIntent(){this.basketService.createPaymentIntent().subscribe({next:()=>{this.appStepper?.next()},error:r=>this.toastr.error(r.message)})}};e.\u0275fac=function(t){return new(t||e)(u(k),u(_))},e.\u0275cmp=f({type:e,selectors:[["app-checkout-review"]],inputs:{appStepper:"appStepper"},decls:9,vars:1,consts:[[1,"mt-4"],[3,"isBasket"],[1,"d-flex","justify-content-between","flex-row","mb-5"],["cdkStepperPrevious","",1,"btn","btn-outline-primary"],[1,"fa","fa-angle-left"],[1,"btn","btn-primary",3,"click"],[1,"fa","fa-angle-right"]],template:function(t,o){t&1&&(n(0,"div",0),l(1,"app-basket-summary",1),s(),n(2,"div",2)(3,"button",3),l(4,"i",4),p(5,"Back to delivery "),s(),n(6,"button",5),b("click",function(){return o.createPaymentIntent()}),p(7," Go to payment"),l(8,"i",6),s()()),t&2&&(m(),c("isBasket",!1))},dependencies:[I,Fe]});let i=e;return i})();var Te="https://js.stripe.com/v3",ze=/^https:\/\/js\.stripe\.com\/v3\/?(\?.*)?$/,Me="loadStripe.setLoadParameters was called but an existing Stripe.js script already exists in the document; existing script parameters will be used",Je=function(){for(var e=document.querySelectorAll('script[src^="'.concat(Te,'"]')),a=0;a<e.length;a++){var r=e[a];if(ze.test(r.src))return r}return null},je=function(e){var a=e&&!e.advancedFraudSignals?"?advancedFraudSignals=false":"",r=document.createElement("script");r.src="".concat(Te).concat(a);var t=document.head||document.body;if(!t)throw new Error("Expected document.body not to be null. Stripe.js requires a <body> element.");return t.appendChild(r),r},Ke=function(e,a){!e||!e._registerWrapper||e._registerWrapper({name:"stripe-js",version:"3.3.0",startTime:a})},N=null,Z=null,z=null,$e=function(e){return function(){e(new Error("Failed to load Stripe.js"))}},et=function(e,a){return function(){window.Stripe?e(window.Stripe):a(new Error("Stripe.js not available"))}},tt=function(e){return N!==null?N:(N=new Promise(function(a,r){if(typeof window>"u"||typeof document>"u"){a(null);return}if(window.Stripe&&e&&console.warn(Me),window.Stripe){a(window.Stripe);return}try{var t=Je();if(t&&e)console.warn(Me);else if(!t)t=je(e);else if(t&&z!==null&&Z!==null){var o;t.removeEventListener("load",z),t.removeEventListener("error",Z),(o=t.parentNode)===null||o===void 0||o.removeChild(t),t=je(e)}z=et(a,r),Z=$e(r),t.addEventListener("load",z),t.addEventListener("error",Z)}catch(d){r(d);return}}),N.catch(function(a){return N=null,Promise.reject(a)}))},rt=function(e,a,r){if(e===null)return null;var t=e.apply(void 0,a);return Ke(t,r),t},P,Ge=!1,De=function(){return P||(P=tt(null).catch(function(e){return P=null,Promise.reject(e)}),P)};Promise.resolve().then(function(){return De()}).catch(function(i){Ge||console.warn(i)});var Ae=function(){for(var e=arguments.length,a=new Array(e),r=0;r<e;r++)a[r]=arguments[r];Ge=!0;var t=Date.now();return De().then(function(o){return rt(o,a,t)})};var it=["cardNumber"],ot=["cardExpiry"],nt=["cardCvc"];function at(i,e){if(i&1&&(n(0,"div",10)(1,"div",11)(2,"div",12),l(3,"app-text-input",13),s()(),n(4,"div",14)(5,"div",15)(6,"div",16),l(7,"div",17,0),n(9,"label"),p(10,"Card Number"),s(),n(11,"span",18),p(12),s()()(),n(13,"div",19)(14,"div",16),l(15,"div",17,1),n(17,"label"),p(18,"Card Expiry"),s()()(),n(19,"div",19)(20,"div",16),l(21,"div",17,2),n(23,"label"),p(24,"Card Cvc"),s()()()()()),i&2){let a=h();c("formGroup",a.checkoutForm),m(3),c("label","Name on card"),m(9),R(a.cardErrors)}}function st(i,e){i&1&&l(0,"i",20)}var Le=(()=>{let e=class e{constructor(r,t,o,d){this.basketService=r,this.checkoutService=t,this.toastr=o,this.router=d,this.stripe=null,this.cardNumberComplete=!1,this.cardExpiryComplete=!1,this.cardCvcComplete=!1,this.loading=!1}ngOnInit(){Ae("pk_test_51PBpZUAyMOXg7ul6CEjLe9Po0025E3uEldR3MMJCa6A84f9RL1kPRMpLBHOeAq2kWcu9ImamKHYpfZfXt8aGKg0c00prIr6JSk").then(r=>{this.stripe=r;let t=r?.elements();t&&(this.cardNumber=t.create("cardNumber"),this.cardNumber.mount(this.cardNumberElement?.nativeElement),this.cardNumber.on("change",o=>{this.cardNumberComplete=o.complete,o.error?this.cardErrors=o.error.message:this.cardErrors=null}),this.cardExpiry=t.create("cardExpiry"),this.cardExpiry.mount(this.cardExpiryElement?.nativeElement),this.cardExpiry.on("change",o=>{this.cardExpiryComplete=o.complete,o.error?this.cardErrors=o.error.message:this.cardErrors=null}),this.cardCvc=t.create("cardCvc"),this.cardCvc.mount(this.cardCvcElement?.nativeElement),this.cardCvc.on("change",o=>{this.cardCvcComplete=o.complete,o.error?this.cardErrors=o.error.message:this.cardErrors=null}))})}get paymentFormComplete(){return this.checkoutForm?.get("paymentForm")?.valid&&this.cardNumberComplete&&this.cardExpiryComplete&&this.cardCvcComplete}submitOrder(){return M(this,null,function*(){this.loading=!0;let r=this.basketService.getCurrentBasketValue();if(!r)throw new Error("cannot get basket");try{let t=yield this.createOrder(r),o=yield this.confirmPaymentWithStripe(r);if(o.paymentIntent){this.basketService.deleteBasket(r);let d={state:t};this.router.navigate(["checkout/success"],d)}else this.toastr.error(o.error.message)}catch(t){console.log(t),this.toastr.error(t.message)}finally{this.loading=!1}})}confirmPaymentWithStripe(r){return M(this,null,function*(){if(!r)throw new Error("Basket is null");let t=this.stripe?.confirmCardPayment(r.clientSecret,{payment_method:{card:this.cardNumber,billing_details:{name:this.checkoutForm?.get("paymentForm")?.get("nameOnCard")?.value}}});if(!t)throw new Error("Problem attempting payment with stripe");return t})}createOrder(r){return M(this,null,function*(){if(!r)throw new Error("Basket is null");let t=this.getOrderToCreate(r);return ie(this.checkoutService.createOrder(t))})}getOrderToCreate(r){let t=this.checkoutForm?.get("deliveryForm")?.get("deliveryMethod")?.value,o=this.checkoutForm?.get("addressForm")?.value;if(!t||!o)throw new Error("Problem with basket");return{basketId:r.id,deliveryMethodId:t,shipToAddress:o}}};e.\u0275fac=function(t){return new(t||e)(u(k),u(Y),u(_),u(q))},e.\u0275cmp=f({type:e,selectors:[["app-checkout-payment"]],viewQuery:function(t,o){if(t&1&&(O(it,5),O(ot,5),O(nt,5)),t&2){let d;V(d=B())&&(o.cardNumberElement=d.first),V(d=B())&&(o.cardExpiryElement=d.first),V(d=B())&&(o.cardCvcElement=d.first)}},inputs:{checkoutForm:"checkoutForm"},decls:9,vars:3,consts:[["cardNumber",""],["cardExpiry",""],["cardCvc",""],["class","mt-4",3,"formGroup",4,"ngIf"],[1,"d-flex","justify-content-between","flex-row","mb-5"],["cdkStepperPrevious","",1,"btn","btn-outline-primary"],[1,"fa","fa-angle-left"],[1,"btn","btn-primary",3,"click","disabled"],[1,"fa","fa-angle-right"],["class","fa fa-spinner fa-spin",4,"ngIf"],[1,"mt-4",3,"formGroup"],[1,"row"],["formGroupName","paymentForm",1,"form-group","col-12"],["formControlName","nameOnCard",3,"label"],[1,"row","mb-3"],[1,"col-6"],[1,"form-floating"],[1,"form-control"],[1,"text-danger"],[1,"col-3"],[1,"fa","fa-spinner","fa-spin"]],template:function(t,o){t&1&&(v(0,at,25,3,"div",3),n(1,"div",4)(2,"button",5),l(3,"i",6),p(4,"Back to review "),s(),n(5,"button",7),b("click",function(){return o.submitOrder()}),p(6," Submit order"),l(7,"i",8),v(8,st,1,0,"i",9),s()()),t&2&&(c("ngIf",o.checkoutForm),m(5),c("disabled",o.loading||!o.paymentFormComplete),m(3),c("ngIf",o.loading))},dependencies:[g,S,F,E,w,x,W,I]});let i=e;return i})();var Oe=(()=>{let e=class e{constructor(r,t,o){this.fb=r,this.accountService=t,this.basketService=o,this.checkoutForm=this.fb.group({addressForm:this.fb.group({firstName:["",y.required],lastName:["",y.required],street:["",y.required],city:["",y.required],state:["",y.required],zipCode:["",y.required]}),deliveryForm:this.fb.group({deliveryMethod:["",y.required]}),paymentForm:this.fb.group({nameOnCard:["",y.required]})})}ngOnInit(){this.getAddressFromValues(),this.getDeliveryMethodValue()}getAddressFromValues(){this.accountService.getUserAddress().subscribe({next:r=>{r&&this.checkoutForm.get("addressForm")?.patchValue(r)}})}getDeliveryMethodValue(){let r=this.basketService.getCurrentBasketValue();r&&r.deliveryMethodId&&this.checkoutForm.get("deliveryForm")?.get("deliveryMethod")?.patchValue(r.deliveryMethodId.toString())}};e.\u0275fac=function(t){return new(t||e)(u(ge),u(Q),u(k))},e.\u0275cmp=f({type:e,selectors:[["app-checkout"]],decls:15,vars:11,consts:[["appStepper",""],[1,"container","mt-5"],[1,"row"],[1,"col-8"],[3,"label","completed"],[3,"checkoutForm"],[3,"label"],[3,"appStepper"],[1,"col-4"]],template:function(t,o){if(t&1&&(n(0,"div",1)(1,"div",2)(2,"div",3)(3,"app-stepper",null,0)(5,"cdk-step",4),l(6,"app-checkout-address",5),s(),n(7,"cdk-step",4),l(8,"app-checkout-delivery",5),s(),n(9,"cdk-step",6),l(10,"app-checkout-review",7),s(),n(11,"cdk-step",4),l(12,"app-checkout-payment",5),s()()(),n(13,"div",8),l(14,"app-order-totals"),s()()()),t&2){let d,te,re,Re=ce(4);m(5),c("label","Address")("completed",(d=o.checkoutForm.get("addressForm"))==null?null:d.valid),m(),c("checkoutForm",o.checkoutForm),m(),c("label","Delivery")("completed",(te=o.checkoutForm.get("deliveryForm"))==null?null:te.valid),m(),c("checkoutForm",o.checkoutForm),m(),c("label","Review"),m(),c("appStepper",Re),m(),c("label","Payment")("completed",(re=o.checkoutForm.get("paymentForm"))==null?null:re.valid),m(),c("checkoutForm",o.checkoutForm)}},dependencies:[ke,Se,Ce,Ie,Ne,Pe,Le]});let i=e;return i})();function mt(i,e){if(i&1&&(n(0,"button",5),p(1," View your order "),s()),i&2){let a=h();se("routerLink","/orders/",a.order.id,"")}}function lt(i,e){i&1&&(n(0,"button",6),p(1," View your orders "),s())}var Ve=(()=>{let e=class e{constructor(r){this.router=r;let t=this.router.getCurrentNavigation();this.order=t?.extras?.state}};e.\u0275fac=function(t){return new(t||e)(u(q))},e.\u0275cmp=f({type:e,selectors:[["app-checkout-success"]],decls:9,vars:2,consts:[[1,"container","mt-5"],[1,"fa","fa-check-circle","fa-5x",2,"color","green"],[1,"mb-4"],["class","btn btn-outline-success",3,"routerLink",4,"ngIf"],["routerLink","/orders","class","btn btn-outline-success",4,"ngIf"],[1,"btn","btn-outline-success",3,"routerLink"],["routerLink","/orders",1,"btn","btn-outline-success"]],template:function(t,o){t&1&&(n(0,"div",0)(1,"div"),l(2,"i",1),s(),n(3,"h2"),p(4,"Thank you. Your order is confirmed"),s(),n(5,"p",2),p(6," Your order has not shipped yet, but this is to be expected as we a re not a real store! "),s(),v(7,mt,2,2,"button",3)(8,lt,2,0,"button",4),s()),t&2&&(m(7),c("ngIf",o.order),m(),c("ngIf",!o.order))},dependencies:[g,U]});let i=e;return i})();var pt=[{path:"",component:Oe},{path:"success",component:Ve}],Be=(()=>{let e=class e{};e.\u0275fac=function(t){return new(t||e)},e.\u0275mod=T({type:e}),e.\u0275inj=j({imports:[J.forChild(pt),J]});let i=e;return i})();var Xt=(()=>{let e=class e{};e.\u0275fac=function(t){return new(t||e)},e.\u0275mod=T({type:e}),e.\u0275inj=j({imports:[fe,Be,Ee]});let i=e;return i})();export{Xt as CheckoutModule};
